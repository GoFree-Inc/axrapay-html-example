<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AxraPay SDK - External Developer Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #1f2937;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #6b7280;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
        }
        .test-section h3 {
            margin-top: 0;
            color: #374151;
        }
        .result {
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-weight: 500;
        }
        .success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #2563eb;
        }
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .config-section {
            background-color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .config-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }
        .config-section input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .config-section input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .log {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-pending { background-color: #f59e0b; }
        .form-container {
            margin-top: 20px;
            min-height: 200px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            background-color: #f9fafb;
            transition: all 0.3s ease;
        }
        .form-container:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ AxraPay SDK - External Developer Test</h1>
        <p class="subtitle">Test the AxraPay SDK integration from an external domain</p>
        
        <div class="config-section">
            <h3>Configuration</h3>
            <label for="publishableKey">GoPremium Publishable Key:</label>
            <input type="text" id="publishableKey" placeholder="pk_test_your_key_here" value="pk_test_demo_key">
            
            <label for="businessId">Business ID:</label>
            <input type="text" id="businessId" placeholder="your-business-id" value="demo-business-123">
            
            <label for="sdkToken">SDK Token (or leave empty for demo):</label>
            <input type="text" id="sdkToken" placeholder="your-sdk-token" value="">
        </div>

        <div class="test-section">
            <h3>üß™ SDK Initialization Test</h3>
            <p>Test if the SDK can initialize and load business configuration from an external domain.</p>
            <button onclick="testSDKInitialization()">Test SDK Initialization</button>
            <div id="initResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üí≥ Payment Intent Test</h3>
            <p>Test creating a payment intent through the SDK.</p>
            <button onclick="testPaymentIntent()" id="paymentBtn" disabled>Test Payment Intent</button>
            <div id="paymentResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üí≥ Card Form Test</h3>
            <p>Test mounting a card form for direct payments.</p>
            <button onclick="testCardForm()" id="cardFormBtn" disabled>Mount Card Form</button>
            <button onclick="clearCardForm()" id="clearCardFormBtn" disabled>Clear Card Form</button>
            <div id="cardFormResult" class="result" style="display: none;"></div>
            <div id="cardFormContainer" class="form-container"></div>
        </div>

        <div class="test-section">
            <h3>üîê Token Form Test</h3>
            <p>Test mounting a token form for secure card tokenization.</p>
            <button onclick="testTokenForm()" id="tokenFormBtn" disabled>Mount Token Form</button>
            <button onclick="clearTokenForm()" id="clearTokenFormBtn" disabled>Clear Token Form</button>
            <div id="tokenFormResult" class="result" style="display: none;"></div>
            <div id="tokenFormContainer" class="form-container"></div>
        </div>

        <div class="test-section">
            <h3>üîß CORS Test</h3>
            <p>Test if CORS headers are properly set for SDK endpoints.</p>
            <button onclick="testCORS()">Test CORS Headers</button>
            <div id="corsResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üìä Test Logs</h3>
            <button onclick="clearLogs()">Clear Logs</button>
            <div id="logs" class="log">Ready to test...\n</div>
        </div>
    </div>

    <!-- Set empty configuration to prevent auto-initialization -->
    <script>
        // Set empty config to prevent auto-initialization
        window.AxraPayConfig = {};
    </script>

    <!-- Load the AxraPay SDK from your local development server -->
    <script src="https://dev.gopremium.africa/sdk.dev.js"></script>
    
    <script>
        let isSDKInitialized = false;

        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().substr(11, 12);
            const logElement = document.getElementById('logs');
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[AxraPay Test] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').textContent = 'Logs cleared...\n';
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // Test SDK Initialization
        async function testSDKInitialization() {
            log('Starting SDK initialization test...');
            showResult('initResult', 'üîÑ Testing SDK initialization...', 'info');
            
            try {
                const publishableKey = document.getElementById('publishableKey').value;
                const businessId = document.getElementById('businessId').value;
                const sdkToken = document.getElementById('sdkToken').value;

                if (!publishableKey || !businessId) {
                    throw new Error('Please provide both publishable key and business ID');
                }

                // Check if AxraPay is available
                if (typeof window.AxraPay === 'undefined') {
                    throw new Error('AxraPay SDK not loaded. Check if the script loaded correctly.');
                }

                log(`Using form values - Key: ${publishableKey}, Business: ${businessId}`);

                // Update the global configuration with form values
                window.AxraPayConfig = {
                    publishableKey: publishableKey,
                    businessId: businessId,
                    getSdkToken: async () => {
                        if (sdkToken) {
                            log(`Using provided SDK token: ${sdkToken}`);
                            return sdkToken;
                        }
                        // For demo purposes, return a mock token
                        log('Using demo SDK token (replace with real token for production)');
                        return 'demo-sdk-token-123';
                    }
                };

                log('Configuration updated with form values, initializing SDK...');
                log('Current AxraPayConfig:', JSON.stringify(window.AxraPayConfig, null, 2));

                // Force the SDK to use the new configuration by reinitializing
                // Reset the SDK instance with the new configuration
                if (window.AxraPay && typeof window.AxraPay.reset === 'function') {
                    log('Resetting SDK instance...');
                    window.AxraPay.reset();
                }

                // Initialize the SDK with the new configuration
                log('Initializing SDK with new configuration...');
                await window.AxraPay.initialize();
                
                isSDKInitialized = true;
                document.getElementById('paymentBtn').disabled = false;
                document.getElementById('cardFormBtn').disabled = false;
                document.getElementById('tokenFormBtn').disabled = false;
                
                log('SDK initialized successfully with form values!', 'success');
                showResult('initResult', '‚úÖ SDK initialized successfully! Business config loaded.', 'success');
                
            } catch (error) {
                log(`SDK initialization failed: ${error.message}`, 'error');
                showResult('initResult', `‚ùå SDK initialization failed: ${error.message}`, 'error');
                isSDKInitialized = false;
                document.getElementById('paymentBtn').disabled = true;
                document.getElementById('cardFormBtn').disabled = true;
                document.getElementById('tokenFormBtn').disabled = true;
            }
        }

        // Test Payment Intent Creation
        async function testPaymentIntent() {
            if (!isSDKInitialized) {
                showResult('paymentResult', '‚ùå Please initialize the SDK first', 'error');
                return;
            }

            log('Testing payment intent creation...');
            showResult('paymentResult', 'üîÑ Creating payment intent...', 'info');

            try {
                const result = await window.AxraPay.createPaymentIntent({
                    amount: 29.99,
                    currency: 'USD',
                    businessId: document.getElementById('businessId').value, // Use form value
                    customerData: {
                        name: 'Test User',
                        email: 'test@example.com'
                    },
                    description: 'External SDK Test Payment'
                });

                log(`Payment intent created: ${result.id}`, 'success');
                showResult('paymentResult', `‚úÖ Payment intent created successfully! ID: ${result.id}`, 'success');
                
            } catch (error) {
                log(`Payment intent creation failed: ${error.message}`, 'error');
                showResult('paymentResult', `‚ùå Payment intent creation failed: ${error.message}`, 'error');
            }
        }

        // Test Card Form Mounting
        async function testCardForm() {
            if (!isSDKInitialized) {
                showResult('cardFormResult', '‚ùå Please initialize the SDK first', 'error');
                return;
            }

            log('Testing card form mounting...');
            showResult('cardFormResult', 'üîÑ Mounting card form...', 'info');

            try {
                const businessId = document.getElementById('businessId').value;
                
                await window.AxraPay.mountCardForm({
                    selector: '#cardFormContainer',
                    amount: 29.99,
                    currency: 'USD',
                    businessId: businessId,
                    customerData: {
                        name: 'Test User',
                        email: 'test@example.com'
                    },
                    description: 'External SDK Card Form Test',
                    onSuccess: (paymentIntent) => {
                        log(`Card form payment successful: ${paymentIntent.id}`, 'success');
                        showResult('cardFormResult', `‚úÖ Payment successful! ID: ${paymentIntent.id}`, 'success');
                    },
                    onError: (error) => {
                        log(`Card form payment failed: ${error}`, 'error');
                        showResult('cardFormResult', `‚ùå Payment failed: ${error}`, 'error');
                    }
                });

                log('Card form mounted successfully!', 'success');
                showResult('cardFormResult', '‚úÖ Card form mounted successfully! Try making a payment.', 'success');
                document.getElementById('clearCardFormBtn').disabled = false;
                
            } catch (error) {
                log(`Card form mounting failed: ${error.message}`, 'error');
                showResult('cardFormResult', `‚ùå Card form mounting failed: ${error.message}`, 'error');
            }
        }

        // Clear Card Form
        function clearCardForm() {
            const container = document.getElementById('cardFormContainer');
            container.innerHTML = '';
            showResult('cardFormResult', 'Card form cleared', 'info');
            log('Card form cleared');
            document.getElementById('clearCardFormBtn').disabled = true;
        }

        // Test Token Form Mounting
        async function testTokenForm() {
            if (!isSDKInitialized) {
                showResult('tokenFormResult', '‚ùå Please initialize the SDK first', 'error');
                return;
            }

            log('Testing token form mounting...');
            showResult('tokenFormResult', 'üîÑ Mounting token form...', 'info');

            try {
                await window.AxraPay.mountTokenForm({
                    selector: '#tokenFormContainer',
                    customerData: {
                        name: 'Test User',
                        email: 'test@example.com'
                    },
                    style: {
                        backgroundColor: '#10b981',
                        borderRadius: '8px',
                        padding: '12px 24px',
                        fontSize: '16px'
                    },
                    onSuccess: (result) => {
                        log(`Token created successfully: ${result.token.id}`, 'success');
                        showResult('tokenFormResult', `‚úÖ Token created successfully! ID: ${result.token.id}`, 'success');
                        
                        // Show the token for testing
                        log('Token details:', result.token);
                    },
                    onError: (error) => {
                        log(`Token creation failed: ${error}`, 'error');
                        showResult('tokenFormResult', `‚ùå Token creation failed: ${error}`, 'error');
                    }
                });

                log('Token form mounted successfully!', 'success');
                showResult('tokenFormResult', '‚úÖ Token form mounted successfully! Try creating a token.', 'success');
                document.getElementById('clearTokenFormBtn').disabled = false;
                
            } catch (error) {
                log(`Token form mounting failed: ${error.message}`, 'error');
                showResult('tokenFormResult', `‚ùå Token form mounting failed: ${error.message}`, 'error');
            }
        }

        // Clear Token Form
        function clearTokenForm() {
            const container = document.getElementById('tokenFormContainer');
            container.innerHTML = '';
            showResult('tokenFormResult', 'Token form cleared', 'info');
            log('Token form cleared');
            document.getElementById('clearTokenFormBtn').disabled = true;
        }

        // Test CORS Headers
        async function testCORS() {
            log('Testing CORS headers...');
            showResult('corsResult', 'üîÑ Testing CORS headers...', 'info');

            try {
                const businessId = document.getElementById('businessId').value;
                const publishableKey = document.getElementById('publishableKey').value;
                const sdkToken = document.getElementById('sdkToken').value || 'demo-sdk-token-123';

                log('Making cross-origin request to test CORS...');
                log(`From: ${window.location.origin}`);
                log(`To: https://dev.gopremium.africa/api/sdk/config`);

                const response = await fetch(`https://dev.gopremium.africa/api/sdk/config?businessId=${businessId}`, {
                    method: 'GET',
                    headers: {
                        'X-AxraPay-Publishable-Key': publishableKey,
                        'Authorization': `Bearer ${sdkToken}`
                    }
                });

                log(`Response status: ${response.status}`);
                log(`Response headers: ${JSON.stringify([...response.headers.entries()])}`);
                
                // If we get here without a CORS error, CORS is working!
                if (response.ok) {
                    log('CORS test passed - Cross-origin request successful!', 'success');
                    log('Note: CORS headers are not exposed to JavaScript for security reasons', 'info');
                    showResult('corsResult', '‚úÖ CORS test passed! Cross-origin requests are working correctly.', 'success');
                } else {
                    log(`CORS test failed - HTTP error: ${response.status}`, 'error');
                    showResult('corsResult', `‚ùå CORS test failed - HTTP error: ${response.status}`, 'error');
                }
                
            } catch (error) {
                if (error.message.includes('CORS') || error.message.includes('cross-origin')) {
                    log(`CORS test failed - CORS error: ${error.message}`, 'error');
                    showResult('corsResult', `‚ùå CORS test failed - CORS error: ${error.message}`, 'error');
                } else {
                    log(`CORS test failed: ${error.message}`, 'error');
                    showResult('corsResult', `‚ùå CORS test failed: ${error.message}`, 'error');
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('External SDK test page loaded');
            log('Current origin: ' + window.location.origin);
            log('Testing from: ' + window.location.href);
            log('Target SDK server: https://dev.gopremium.africa');
            
            // Check if SDK is loaded with retry mechanism
            setTimeout(() => {
                if (typeof window.AxraPay !== 'undefined') {
                    log('AxraPay SDK loaded successfully', 'success');
                    log('SDK version: ' + window.AxraPay.getVersion());
                } else {
                    log('AxraPay SDK not loaded - check console for errors', 'error');
                }
            }, 1000);
        });
    </script>
</body>
</html>
